generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CloudProvider {
  AWS
  GCP
}

enum SubscriptionPlan {
  FREE
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum AlertChannel {
  EMAIL
  SLACK
}

model User {
  id           String         @id @default(cuid())
  email        String         @unique
  name         String
  passwordHash String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  projects     Project[]
  alertsSent   AlertSent[]
  subscription Subscription?

  @@index([createdAt])
}

model Project {
  id            String         @id @default(cuid())
  userId        String
  name          String
  timezone      String         @default("UTC")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  cloudAccounts CloudAccount[]
  costRecords   CostRecord[]
  alertRules    AlertRule[]

  @@index([userId])
  @@unique([userId, name])
}

model CloudAccount {
  id                   String        @id @default(cuid())
  userId               String
  projectId            String
  provider             CloudProvider @default(AWS)
  accountLabel         String
  externalAccountId    String
  roleArn              String?
  accessKeyEncrypted   String?
  secretKeyEncrypted   String?
  encryptionKeyVersion Int           @default(1)
  isActive             Boolean       @default(true)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  project              Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  costRecords          CostRecord[]

  @@index([projectId])
  @@index([userId])
  @@unique([provider, externalAccountId])
}

model CostRecord {
  id             String       @id @default(cuid())
  projectId      String
  cloudAccountId String
  serviceName    String
  currency       String       @default("USD")
  amount         Decimal      @db.Decimal(12, 4)
  periodStart    DateTime
  periodEnd      DateTime
  granularity    String       @default("HOURLY")
  createdAt      DateTime     @default(now())
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cloudAccount   CloudAccount @relation(fields: [cloudAccountId], references: [id], onDelete: Cascade)

  @@index([projectId, periodStart])
  @@index([cloudAccountId, periodStart])
  @@unique([cloudAccountId, serviceName, periodStart, periodEnd])
}

model AlertRule {
  id                String    @id @default(cuid())
  projectId         String
  dailyBudget       Decimal?  @db.Decimal(12, 2)
  monthlyBudget     Decimal?  @db.Decimal(12, 2)
  spikeThresholdPct Int?
  emailEnabled      Boolean   @default(true)
  slackWebhookUrl   String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  alertsSent        AlertSent[]

  @@index([projectId])
}

model AlertSent {
  id          String       @id @default(cuid())
  userId      String
  projectId   String
  alertRuleId String?
  channel     AlertChannel
  reason      String
  payload     Json
  sentAt      DateTime     @default(now())
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  alertRule   AlertRule?   @relation(fields: [alertRuleId], references: [id], onDelete: SetNull)

  @@index([userId, sentAt])
  @@index([projectId, sentAt])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  plan                 SubscriptionPlan   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}
